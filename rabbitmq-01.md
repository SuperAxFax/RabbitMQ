# RabbitMQ 

## 1：什么是中间件

1：什么是中间件

​         现在大多数的系统都是基于微服务分布式去开发的。也就是一个系统被拆分为一些模块，然后我们要去选择合适的中间件在它们之间完成互连互通的作用。

![1654930758726](6_11_2.assets/1654930758726.png)

2：使用中间件的注意事项

​        中间件技术在现在的互联网公司用的较多，如果是初创公司建议使用单体架构，最多加个缓存中间件即可。但是作为开发人员，一定要有学习中间件技术的能力和思维，否则很容易当项目发展到一个阶段1再去掌握或者面试中问到会给自己带来不小的困扰。而且在这个时代这些技术也不是什么新鲜的东西，如何掌握和挖掘还是需要自己花时间和精力去探究。

## 2：中间件技术及单体和分布式架构

### 1：中间件技术

- 分布式消息中间件
  1. ActiveMQ
  2. RabbitMQ
  3. Kafka
  4. RocketMQ
- 负载均衡中间件
  1. Nginx
  2. CDN  
- 缓存中间件
  1. MemCache
  2. Redis
- 数据库中间件
  1. Mycat
  2. ShardingJdbc

### 2：单体架构

简介：

​         企业开发中，大部分的初级架构都采用的是单体架构模式进行架构，这种架构的特点是：把所有的业务和模块，源代码，静态资源文件都放在一个工程中，如果其中的一个模块升级或者迭代发生一个很小的变动都会重新编译和重新部署项目。这种架构存在的问题就是：

1. 耦合度太高
2. 运维的成本过高
3. 不易维护
4. 服务器的成本高
5. 升级架构的复杂度很大

![1654931797194](6_11_2.assets/1654931797194.png)



### 3：分布式架构

![1654932060306](6_11_2.assets/1654932060306.png)

(1)：什么是分布式架构呢？

​        通俗一点就是一个请求由服务器端的多个服务（或者系统）协同处理完成。

(2)：与单体架构区别

​       和单体架构不同的是，单体架构是一个请求发起jvm调度线程（确切的是tomcat线程池）分配线程Thread来处理请求直到释放，而分布式架构是：一个请求是由多个系统共同来协同完成，jvm和环境都可能是独立的。如果生活中的比喻的话，单体架构就像建设一个小房子很快就能搞定，如果要建设一个鸟巢或者大型的建筑，就必须是各个环节的协同和分布。

(3)：分布式架构存在的问题

1. 学习成本高，技术栈过多
2. 运维成本和服务器成本高
3. 项目负载度上升，错误和容错性上升；占用的服务器端口和通讯的选择成本高

(4):分布式架构的好处

1. 可以合理分配服务资源，不造成服务器资源的浪费
2. 系统的独立维护和部署，耦合度降低，具有可插拔性
3. 系统的架构和技术栈的选择可以变得灵活（而不是单纯的选择java）
4. 弹性的部署，不会造成因平台的部署而导致的瘫痪和停服的状态

## 3：基于消息中间件的分布式系统的架构

### 1：架构图示

![1654932988549](6_11_2.assets/1654932988549.png)

由上图可得：

- 利用可靠的消息传递机制进行系统和系统间的直接通讯
- 通过提供消息传递和消息的排队机制，它可以在分布式系统环境下扩展进程间通讯

###  2：消息中间件的应用场景

- 跨系统的数据传递

- 高并发的流量削峰

  串行执行：

  ![1654933584791](6_11_2.assets/1654933584791.png)

  并行执行：

  ![1654933604352](6_11_2.assets/1654933604352.png)

- 数据的分发和异步处理

- 大数据分析与传递

- 分布式事务

### 3：常见的消息中间件

- ActiveMQ
- RabbitMQ
- Kafka
- RocketMQ

### 4：消息中间件的本质

它是一种接收数据，接收请求，存储数据，发送数据的技术服务；

### 5：消息中间件的核心组成部分

1. 消息的协议
2. 消息的持久化机制
3. 消息的分发策略
4. 消息的高可用，高可靠
5. 消息的容错机制

## 4：消息队列协议

1：什么是协议

![1654934151102](6_11_2.assets/1654934151102.png)

​       我们知道消息中间件负责数据的接收，存储和分发三个部分，数据的存储和分发肯定要遵循某种约定俗成的规范，无论是采用底层的TCP/IP，UDP协议还是自己构建的，这些约定俗成的规范就称为协议。

>协议是指：
>
>1：计算机底层操作系统和应用程序通讯时共同遵守的一组约定，只有遵循共同的约定和规范，系统和底层操作系统之间才能相互交流。
>
>2：和一般的网络应用程序的不同在于它主要负责数据的接受和传递，所以性能比较高。
>
>3：协议对数据格式和计算机之间交换数据都必须严格遵守规范。

2：网络协议的三要素

1：语法。语法是用户数据与控制信息的结构与格式，以及数据出现的顺序。

2:   语义。语义是解释控制信息每个部分的意义。它规定了需要发出何种控制信息，以及完成的动作与做出什么样的响应。

3：时序。时序是对事件发生顺序的详细说明。

解释（以http请求协议为例）：

>1：语法：http规定了请求报文和响应报文的格式。
>
>2：语义：客户端主动发起请求称之为请求。（这是一种定义，同时发起的是post/get请求）
>
>3；时序：一个请求对应一个响应。（一定先有请求再有响应，这个是时序）

3：常用的消息中间件协议及面试题

​        消息中间件采用的并不是http协议，常见的消息中间件协议有：OpenWire，AMQP，MQTT，Kafka，OpenMessage协议。

>面试题：为什么消息中间件不直接使用http协议
>
>1：因为http请求报文头和响应报文头比较复杂，包含了cookie，数据的加密解密，状态码，响应码等附加的功能，但是对于一个消息而言，我们并不需要这么复杂，也没有这个必要性，它其实就是负责数据接收，存储，分发就行，追求的是高性能，要求简洁，快速。
>
>2：大部分情况下http都是短链接在实际的交互过程中，一个请求到响应很可能会中断，中断以后就不会持久化，就会造成请求的丢失。这样就不利于消息中间件的应用场景，因为消息中间件可能是一个长期的获取消息的过程，出现问题和故障要对数据或消息进行持久化，目的是为了保证消息和数据的高可靠和稳健运行。

4：常见协议的简介

- AMQP协议

  ​        全称是Advanced Message Queuing Protocol是高级消息队列协议。是一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的i一个开发标准，为面向消息的中间件设计。

  ​        特性是：

  1.  分布式事务支持
  2.  消息的持久化支持
  3.  高性能和高可靠的消息处理优势

![1654938127461](6_11_2.assets/1654938127461.png)

- MQTT协议 

  ​      全称是Message Queueing Telemetry Transport消息队列是IBM开放的一个即时通讯协议。

  ​      特点：

  1.  轻量，结构简单
  2.  传输快，不支持事务
  3.  没有持久化设计

     

  ​        应用场景：

  1.  适用于计算能力有限
  2.  低带宽和网络不稳定的场景

![1654938343315](6_11_2.assets/1654938343315.png)

- OpenMessage协议

     由阿里，雅虎和滴滴出行创立的分布式消息中间件，流处理等领域的应用开发标准。

     特点：

  1.  结构简单

  2.   解析速度快，支持事务和持久化设计

       

![1654938510331](6_11_2.assets/1654938510331.png)

- Kafka协议

     Kafka协议是基于TCP/IP的二进制协议。消息内部是通过长度来分隔，由一些基本数据类型组成。

     特点是：

  1. 结构简单，解析速度快
  2. 无事务支持，有持久化设计
  3.  接近底层，速度极快

5：协议小结

​      协议：就是在TCP/IP协议基础之上构建的一种约定俗成的规范和机制，它的主要目的是可以让客户端（应用程序java,go）进行沟通和通讯。并且这种协议下规范必须具有持久性，高可用，高可靠的性能。

## 5：消息队列的持久化

1：持久化

简单来说就是将数据存入磁盘，而不是存在内存中随服务器重启而消失，使数据能够永久保存。

![1654939633555](6_11_2.assets/1654939633555.png)

2：常见的持久化方式

![1654939759714](6_11_2.assets/1654939759714.png)

说明这些消息中间件都支持持久化，就是即使服务器重启之后，数据也不会丢失。

## 6：消息的分发策略

### 1：消息队列中的三个角色

MQ消息队列中包含三个角色：

- 生产者
- 存储消息
- 消费者

​         生产者生成消息之后，MQ进行存储，消费者是如何获取消息的呢？获取数据的方式不是推（push）就是拉（pull）。典型这种推拉机制的有：git和http请求数据。

​         消息队列MQ是一种推送的过程。

### 2：场景分析一

![1654940219482](6_11_2.assets/1654940219482.png)

>比如我在APP上下了一个订单，我们的系统和服务很多，那么我们如何得知这个消息被哪个系统或者哪些服务进行消费了呢？这时我们就需要一个分发的策略。

### 3: 场景分析二

![1654940649409](6_11_2.assets/1654940649409.png)

>在发送消息的过程中可能会出现异常或者网络的抖动故障等原因造成消费者无法消费。比如用户在下订单，订单系统返回时出现故障，导致用户支付失败，那么这个时候就需要消息中间件必须支持消息重试机制策略。也就是支持：出现问题和故障的情况下，消息不丢失还可以进行重发。

### 4：消息分发策略的机制与对比

![1654960212871](6_11_2.assets/1654960212871.png)

## 7：消息队列高可用和高可靠

### 1：什么是高可用机制

一句话：无论你服务器出现什么问题，都不能出现宕机。

当业务量增加时，请求也过大，一台消息中间件服务器会达到硬件（CPU，内存，磁盘）的极限，一台消息服务器已经无法满足业务的需求，所以消息中间件必须支持集群部署来达到高可用的目的。

### 2：五种集群模式

1：集群模式1-Master-slave主从共享数据的部署方式

![1654960779102](6_11_2.assets/1654960779102.png)

生产者将消息发送到Master节点，所有的所有的消息服务器都连接消息队列，共享这块数据区域，Master节点负责写入，一旦Master节点挂掉，slave节点继续服务，从而形成高可用。

2：集群模式2-Master-slave主从同步部署方式

![1654961182387](6_11_2.assets/1654961182387.png)

解释：这种模式写入消息同样在Master主节点上，但是主节点会同步数据到slave节点上形成副本，和zookeeper或者redis主从机制很类似。这样可以达到负载均衡的效果，如果消费者有多个，那么消费者就可以到不同的节点进行消费，。但是消息的拷贝和同步会占用很大的带宽和网络资源，在后续的rabbitmq中会有使用。

3：多主多从的集群同步部署模式

![1654961477262](6_11_2.assets/1654961477262.png)

解释：和上一个的区别不是很大，改变就是它的写入可以往任意节点去写入。

4：集群模式4-多主集群转发部署模式

![1654961685387](6_11_2.assets/1654961685387.png)

解释：元数据信息里面存放的不是完整的数据信息，是关于数据的相关描述和记录存放的位置。消费者从任意一个服务器去访问，如果该服务器的元数据信息里面没有，就转发到别的服务器中去查询元数据信息。如果查到了就返回，查询完了没找到就返回为空。

5：集群模式5-Master-slave与Breoker-cluster组合的多主多从解决方案

![](6_11_2.assets/1654961872715.png)

解释：这种多主多从的设计模式用于大规模的项目，一般小公司项目不会用到。

>小结：
>
>1：这些集群模式的最终目的都是保证消息服务器即使是出现故障也不会挂掉。
>
>2：以上五种集群模式归纳起来就是：
>
>- 消息共享（主从共享）
>- 消息同步（主从同步，多主多从同步，组合多主多从）
>- 元数据共享（多主集群转发模式）



8：RabbitMQ入门及安装

9：Web管理界面及授权操作组

10：Docker安装RabbitMQ

11：角色分类

12：快速入门案例

13：AMQP讲解

14：RabbitMQ的组件及架构

15：简单模式理解



定位一下公司的开发属于网络中，技术中的哪一部分内容，让其成为自己拼图的一部分。